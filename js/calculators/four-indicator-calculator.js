// 4指標診断計算ロジック（参考診断）
// E/I, S/N, T/F, J/P の4指標を計算

class FourIndicatorCalculator {
  calculate(answers, questions) {
    const scores = {
      E: 0, I: 0,
      S: 0, N: 0,
      T: 0, F: 0,
      J: 0, P: 0
    };
    const lang = typeof i18n !== 'undefined' ? i18n.getCurrentLanguage() : 'ja';
    const mbtiTranslations = (typeof resultTranslations !== 'undefined' && resultTranslations[lang] && resultTranslations[lang].mbti)
      ? resultTranslations[lang].mbti
      : null;

    answers.forEach(answer => {
      const question = questions.find(q => q.id === answer.questionId);
      if (!question || !question.mappings || !question.mappings.fourIndicator) return;

      const mapping = question.mappings.fourIndicator;
      const value = answer.value * mapping.value;
      const weightedValue = value * mapping.weight;

      // 各指標にスコアを加算
      if (mapping.dimension === 'E/I') {
        if (value > 0) {
          scores.E += weightedValue;
        } else {
          scores.I += Math.abs(weightedValue);
        }
      } else if (mapping.dimension === 'S/N') {
        if (value > 0) {
          scores.S += weightedValue;
        } else {
          scores.N += Math.abs(weightedValue);
        }
      } else if (mapping.dimension === 'T/F') {
        if (value > 0) {
          scores.T += weightedValue;
        } else {
          scores.F += Math.abs(weightedValue);
        }
      } else if (mapping.dimension === 'J/P') {
        if (value > 0) {
          scores.J += weightedValue;
        } else {
          scores.P += Math.abs(weightedValue);
        }
      }
    });

    // タイプを判定
    const type = 
      (scores.E > scores.I ? 'E' : 'I') +
      (scores.S > scores.N ? 'S' : 'N') +
      (scores.T > scores.F ? 'T' : 'F') +
      (scores.J > scores.P ? 'J' : 'P');

    let typeNames = {
      'ENFP': 'キャンペーナー',
      'ENFJ': '教師',
      'ENTP': '討論者',
      'ENTJ': '指揮官',
      'ESFP': 'エンターテイナー',
      'ESFJ': '領事',
      'ESTP': '起業家',
      'ESTJ': '管理者',
      'INFP': '仲介者',
      'INFJ': '提唱者',
      'INTP': '論理学者',
      'INTJ': '建築家',
      'ISFP': '冒険家',
      'ISFJ': '擁護者',
      'ISTP': '職人',
      'ISTJ': '管理者'
    };

    // タイプの詳細説明
    let typeDescriptions = {
      'ENFP': '創造的で熱心なキャンペーナー（Campaigner）。ENFPは自由な発想と情熱で、新しい可能性を探求し、人々とつながることを好むタイプです。創造性とコミュニケーション能力に優れ、周囲を巻き込む力があります。楽観的で、未来への希望を持ち、人々にインスピレーションを与えることができます。柔軟性が高く、変化を恐れず、常に新しい挑戦を求めます。内面的な価値観を大切にし、自分らしさを追求します。',
      'ENFJ': 'カリスマ的な教師タイプ（Protagonist）。ENFJは人々の成長を支援し、チームを導くことを得意とするリーダータイプです。共感力が高く、他者の可能性を引き出すことができます。明確なビジョンを持ち、そのビジョンを他者と共有することで、チーム全体を目標達成に導きます。協調性と組織力に優れ、人々の調和を保つことができます。他者の成功を自分の成功として喜び、チーム全体の成長を重視します。',
      'ENTP': '論理的で創造的な討論者（Debater）。ENTPは新しいアイデアを生み出し、議論を楽しむタイプです。創造的思考と論理的思考を兼ね備え、既存の枠組みに疑問を投げかけることで、イノベーションを起こします。挑戦を好み、リスクを恐れず、常に新しい可能性を探求します。適応力が高く、変化する環境に柔軟に対応できます。知識欲が強く、複雑な問題を解決することを楽しみます。',
      'ENTJ': '戦略的な指揮官（Commander）。ENTJは目標達成のために組織を導くリーダーシップを持ちます。効率性と結果を重視し、長期的な視点で計画を立て、実行します。決断力があり、迅速に行動し、チーム全体を成功に導くことができます。戦略的思考に優れ、複雑な問題を解決する能力が高いです。組織を効率的に運営し、目標達成に向けてチームを動かすことが得意です。',
      'ESFP': '自由で楽観的なエンターテイナー（Entertainer）。ESFPは現在を楽しみ、人々を楽しませることを好むタイプです。社交的で、エネルギッシュで、周囲の雰囲気を明るくすることができます。柔軟性が高く、臨機応変に対応でき、新しい経験を積極的に受け入れます。実践的で、実際の経験から学ぶことを好みます。現在を大切にし、未来への不安よりも現在の楽しみを重視します。',
      'ESFJ': '協調的な領事タイプ（Consul）。ESFJは伝統を大切にし、人々の調和を保つことを重視します。責任感が強く、他者をサポートすることが得意です。組織力があり、チームワークを重視し、安定した環境を作り出すことができます。細部への注意力が高く、他者のニーズを敏感に察知し、適切にサポートします。他者の幸福を自分の幸福として感じ、チーム全体の調和を保つことができます。',
      'ESTP': '行動力のある起業家（Entrepreneur）。ESTPはリスクを取って、迅速に行動することを好むタイプです。実践的で、現実的な問題解決が得意です。エネルギッシュで、挑戦を恐れず、実際の経験から学ぶことを重視します。適応力が高く、変化する環境に柔軟に対応できます。現在を楽しみ、未来への不安よりも現在の行動を重視します。',
      'ESTJ': '実務的な管理者（Executive）。ESTJは効率性と組織性を重視し、ルールに従うことを好みます。信頼性が高く、責任感が強く、着実に目標を達成します。組織力があり、チームをまとめ、効率的に運営することができます。実務能力に優れ、現実的な判断が得意です。伝統と秩序を重視し、安定した環境を作り出すことができます。',
      'INFP': '理想主義的な仲介者（Mediator）。INFPは価値観を大切にし、創造的な表現を好むタイプです。内面的な世界が豊かで、深い共感力を持ちます。理想を追求し、自分の価値観に合った行動を取ることを重視します。柔軟性があり、他者の感情を理解し、支援することができます。創造性と個性を大切にし、自分らしさを追求します。',
      'INFJ': '洞察力のある提唱者（Advocate）。INFJは最も稀なタイプの一つで、深い洞察力と共感力を持ち、人々の本質を見抜く能力があります。未来への明確なビジョンを持ち、理想を追求する情熱的なタイプです。他者の成長を支援し、世界をより良い場所に変えたいという強い使命感を持っています。内面的な世界が豊かで、創造性と直感力を兼ね備えています。',
      'INTP': '論理的な論理学者（Logician）。INTPは理論を探求し、複雑な問題を解決することを好むタイプです。客観的な分析が得意で、知識を追求します。独立性が高く、自分のペースで作業を進めることを好みます。創造的思考と論理的思考を兼ね備え、新しいアイデアを生み出すことができます。知識欲が強く、複雑な問題を解決することを楽しみます。',
      'INTJ': '戦略的な建築家（Architect）。INTJは長期的な視点で計画を立て、効率的に実行します。独立性が高く、自分のビジョンを実現する力があります。戦略的思考に優れ、複雑な問題を解決する能力が高いです。効率性を重視し、無駄を排除して目標達成に向かいます。知識欲が強く、継続的な学習を重視します。',
      'ISFP': '柔軟で芸術的な冒険家（Adventurer）。ISFPは美しいものを好み、現在を大切にします。創造性が高く、個人的な価値観を重視します。柔軟性があり、状況に応じて対応できます。内面的な世界が豊かで、美的感覚に優れています。現在を楽しみ、未来への不安よりも現在の経験を重視します。',
      'ISFJ': '献身的な擁護者（Defender）。ISFJは責任感が強く、人々を守ることを重視します。細部への注意力が高く、他者をサポートすることが得意です。信頼性が高く、継続的な作業を好みます。他者のニーズを敏感に察知し、適切にサポートします。伝統を大切にし、安定した環境を作り出すことができます。',
      'ISTP': '実用的な職人（Virtuoso）。ISTPは技術的な問題を解決し、実践的なスキルを好みます。論理的で、効率的な解決策を見つけることが得意です。独立性が高く、自分のペースで作業を進めることを好みます。実践的な経験から学ぶことを重視し、実際のスキルを身につけることができます。',
      'ISTJ': '責任感のある管理者（Logistician）。ISTJは信頼性が高く、伝統と秩序を重視します。計画性が高く、着実に目標を達成します。実務能力に優れ、効率的に作業を進めることができます。責任感が強く、約束を守ることを重視します。安定した環境を作り出し、継続的な成果を出すことが得意です。'
    };

    // タイプの強み
    let typeStrengths = {
      'ENFP': '創造性、熱意、コミュニケーション能力、柔軟性、人々とのつながり',
      'ENFJ': 'リーダーシップ、共感力、他者の成長支援、チームワーク、ビジョン',
      'ENTP': '創造的思考、論理的思考、議論力、適応性、イノベーション',
      'ENTJ': '戦略的思考、リーダーシップ、効率性、決断力、目標達成',
      'ESFP': '楽観性、柔軟性、社交性、実践性、現在を楽しむ力',
      'ESFJ': '協調性、責任感、他者への配慮、組織力、伝統の尊重',
      'ESTP': '行動力、実践性、適応性、リスクテイク、問題解決',
      'ESTJ': '組織力、責任感、効率性、信頼性、実務能力',
      'INFP': '創造性、価値観の重視、共感力、柔軟性、内面的な深さ',
      'INFJ': '洞察力、共感力、ビジョン、他者の成長支援、深い理解',
      'INTP': '論理的思考、分析力、知識の追求、独立性、客観性',
      'INTJ': '戦略的思考、独立性、効率性、長期的視点、ビジョン実現',
      'ISFP': '創造性、柔軟性、美的感覚、個人的価値観、現在を大切にする',
      'ISFJ': '責任感、他者への配慮、細部への注意力、信頼性、献身性',
      'ISTP': '実践性、論理的思考、問題解決、独立性、技術的スキル',
      'ISTJ': '責任感、信頼性、計画性、組織力、伝統の尊重'
    };

    // 成長のヒント
    let typeGrowthTips = {
      'ENFP': '長期的な目標設定と計画性を意識し、細部への注意力を高めましょう。感情的な判断を避け、論理的な分析も取り入れると良いでしょう。',
      'ENFJ': '自分のニーズも大切にし、完璧主義を避けましょう。時には一人の時間を取って、自分自身をケアすることも重要です。',
      'ENTP': '感情的な側面も考慮し、他者の気持ちに配慮しましょう。計画性を高め、長期的な視点を持つと良いでしょう。',
      'ENTJ': '感情的な側面も大切にし、他者への共感力を高めましょう。柔軟性を持ち、時には計画を変更することも必要です。',
      'ESFP': '長期的な計画を立て、目標設定を意識しましょう。感情的な判断を避け、論理的な分析も取り入れると良いでしょう。',
      'ESFJ': '自分のニーズも大切にし、完璧主義を避けましょう。変化への適応力を高め、柔軟性を持つと良いでしょう。',
      'ESTP': '長期的な視点を持ち、計画性を高めましょう。感情的な側面も考慮し、他者の気持ちに配慮することが重要です。',
      'ESTJ': '感情的な側面も大切にし、柔軟性を持ちましょう。変化への適応力を高め、新しいアイデアを受け入れると良いでしょう。',
      'INFP': '実践的な行動を意識し、計画性を高めましょう。感情的な判断を避け、論理的な分析も取り入れると良いでしょう。',
      'INFJ': '実践的な行動を意識し、完璧主義を避けましょう。自分のニーズも大切にし、時には一人の時間を取ることも重要です。理想と現実のバランスを取り、過度な自己犠牲を避けることが大切です。感情的な疲労を感じたら、適切に休息を取り、自分自身をケアしましょう。',
      'INTP': '感情的な側面も大切にし、他者への共感力を高めましょう。実践的な行動を意識し、計画性を高めると良いでしょう。',
      'INTJ': '感情的な側面も大切にし、他者への共感力を高めましょう。柔軟性を持ち、時には計画を変更することも必要です。',
      'ISFP': '長期的な計画を立て、目標設定を意識しましょう。感情的な判断を避け、論理的な分析も取り入れると良いでしょう。',
      'ISFJ': '自分のニーズも大切にし、完璧主義を避けましょう。変化への適応力を高め、柔軟性を持つと良いでしょう。',
      'ISTP': '感情的な側面も考慮し、他者の気持ちに配慮しましょう。長期的な視点を持ち、計画性を高めると良いでしょう。',
      'ISTJ': '感情的な側面も大切にし、柔軟性を持ちましょう。変化への適応力を高め、新しいアイデアを受け入れると良いでしょう。'
    };

    // キャリアアドバイス
    let typeCareerAdvice = {
      'ENFP': '創造性を活かせる職種（デザイナー、マーケター、起業家、コーチ）や、人とのつながりが重要な職種が適しています。自由度の高い環境で、新しいアイデアを形にできる環境を選びましょう。',
      'ENFJ': 'リーダーシップが求められる職種（マネージャー、教師、人事、コーチ）や、他者の成長を支援できる職種が適しています。チームを導き、人々の成長を支援できる環境を選びましょう。',
      'ENTP': '創造的で論理的な思考が求められる職種（エンジニア、コンサルタント、起業家、研究者）が適しています。新しいアイデアを試し、議論を楽しめる環境を選びましょう。',
      'ENTJ': '戦略的思考とリーダーシップが求められる職種（経営者、プロジェクトマネージャー、コンサルタント、投資家）が適しています。目標達成と組織運営ができる環境を選びましょう。',
      'ESFP': '楽観性と社交性を活かせる職種（営業、イベント企画、エンターテイナー、カスタマーサービス）が適しています。人々を楽しませ、現在を楽しめる環境を選びましょう。',
      'ESFJ': '協調性と責任感を活かせる職種（人事、カスタマーサービス、教師、医療従事者）が適しています。チームワークと伝統を大切にできる環境を選びましょう。',
      'ESTP': '行動力と実践性を活かせる職種（営業、起業家、アスリート、緊急対応）が適しています。迅速に行動し、リスクを取れる環境を選びましょう。',
      'ESTJ': '組織力と責任感を活かせる職種（マネージャー、公務員、経理、品質管理）が適しています。効率性と組織性を重視できる環境を選びましょう。',
      'INFP': '創造性と価値観を活かせる職種（作家、デザイナー、カウンセラー、NPO職員）が適しています。自分の価値観に合った、創造的な表現ができる環境を選びましょう。',
      'INFJ': '洞察力と共感力を活かせる職種が最適です。カウンセラー、心理学者、人事、教師、ライター、編集者、NPO職員、ソーシャルワーカー、コーチ、コンサルタントなど、人々の成長を支援し、深い理解と共感が求められる職種で力を発揮できます。理想を追求し、社会に貢献できる環境を選びましょう。創造的な分野（作家、デザイナー、アーティスト）でも、内面的な深さを表現できます。',
      'INTP': '論理的思考と分析力を活かせる職種（研究者、エンジニア、データアナリスト、コンサルタント）が適しています。理論を探求し、複雑な問題を解決できる環境を選びましょう。',
      'INTJ': '戦略的思考と独立性を活かせる職種（経営者、システムアーキテクト、研究者、投資家）が適しています。長期的な視点で計画を立て、効率的に実行できる環境を選びましょう。',
      'ISFP': '創造性と柔軟性を活かせる職種（アーティスト、デザイナー、カウンセラー、自然関連）が適しています。美しいものを好み、現在を大切にできる環境を選びましょう。',
      'ISFJ': '責任感と献身性を活かせる職種（看護師、教師、事務職、カスタマーサービス）が適しています。他者を守り、信頼性を提供できる環境を選びましょう。',
      'ISTP': '実用性と技術的スキルを活かせる職種（エンジニア、技術者、職人、アスリート）が適しています。技術的な問題を解決し、実践的なスキルを活かせる環境を選びましょう。',
      'ISTJ': '責任感と信頼性を活かせる職種（公務員、経理、品質管理、システム管理者）が適しています。信頼性と組織性を重視できる環境を選びましょう。'
    };

    // 人間関係での活用
    let typeRelationships = {
      'ENFP': '熱意と創造性で人々を鼓舞し、新しい可能性を探求する姿勢が魅力的です。感情的なつながりを大切にし、他者の成長を支援することで、深い関係を築けます。',
      'ENFJ': '共感力とリーダーシップで、チームの調和を保ちながら目標達成を導きます。他者の成長を支援し、ビジョンを共有することで、強い結束を生み出せます。',
      'ENTP': '創造的で論理的な議論を通じて、新しいアイデアを生み出します。挑戦を恐れず、既存の枠組みに疑問を投げかけることで、イノベーションを起こせます。',
      'ENTJ': '戦略的思考と決断力で、チームを目標達成に導きます。効率性と結果を重視し、明確な方向性を示すことで、組織を成功に導けます。',
      'ESFP': '楽観性と社交性で、チームの雰囲気を明るくします。現在を楽しみ、人々を楽しませることで、ポジティブな環境を作り出せます。',
      'ESFJ': '協調性と責任感で、チームの調和を保ちます。伝統を大切にし、他者への配慮を示すことで、信頼関係を築けます。',
      'ESTP': '行動力と実践性で、迅速に問題を解決します。リスクを取って挑戦し、実際の経験から学ぶ姿勢が魅力的です。',
      'ESTJ': '組織力と責任感で、チームを効率的に運営します。ルールと秩序を重視し、信頼性を提供することで、安定した環境を作り出せます。',
      'INFP': '価値観と創造性で、深い意味のある関係を築きます。理想を追求し、他者の感情を理解することで、共感の深い関係を生み出せます。',
      'INFJ': '洞察力と共感力で、他者の本質を深く理解します。表面的な関係ではなく、深いつながりを求める傾向があります。他者の成長を支援し、理想を共有することで、強い信頼関係を築けます。感情的な理解力が高く、他者の気持ちを敏感に察知できるため、カウンセリングやコーチングの場面で力を発揮します。ただし、過度な共感による疲労に注意し、適切な境界線を保つことが大切です。',
      'INTP': '論理的思考と分析力で、複雑な問題を解決します。理論を探求し、客観的な視点を提供することで、チームの判断をサポートできます。',
      'INTJ': '戦略的思考と独立性で、長期的なビジョンを実現します。効率性と計画性を重視し、明確な方向性を示すことで、組織を成功に導けます。',
      'ISFP': '柔軟性と美的感覚で、個性的な関係を築きます。現在を大切にし、個人的な価値観を尊重することで、深いつながりを生み出せます。',
      'ISFJ': '責任感と献身性で、他者を守り支援します。細部への注意力と信頼性を示すことで、安心できる関係を築けます。',
      'ISTP': '実用性と技術的スキルで、実際の問題を解決します。独立心と論理的思考を示すことで、信頼できるパートナーとして機能できます。',
      'ISTJ': '責任感と信頼性で、安定した関係を築きます。一貫性と組織性を示すことで、信頼できる存在として機能できます。'
    };

    if (mbtiTranslations) {
      typeNames = mbtiTranslations.typeNames || typeNames;
      typeDescriptions = mbtiTranslations.typeDescriptions || typeDescriptions;
      typeStrengths = mbtiTranslations.typeStrengths || typeStrengths;
      typeGrowthTips = mbtiTranslations.typeGrowthTips || typeGrowthTips;
      typeCareerAdvice = mbtiTranslations.typeCareerAdvice || typeCareerAdvice;
      typeRelationships = mbtiTranslations.typeRelationships || typeRelationships;
    }

    const mbtiFallbacks = mbtiTranslations && mbtiTranslations.fallbacks ? mbtiTranslations.fallbacks : null;
    return {
      type: type,
      typeName: typeNames[type] || type,
      typeDescription: typeDescriptions[type] || (mbtiFallbacks ? mbtiFallbacks.typeDescription : null),
      strengths: typeStrengths[type] || (mbtiFallbacks ? mbtiFallbacks.strengths : null),
      growthTips: typeGrowthTips[type] || (mbtiFallbacks ? mbtiFallbacks.growthTips : null),
      careerAdvice: typeCareerAdvice[type] || (mbtiFallbacks ? mbtiFallbacks.careerAdvice : null),
      relationships: typeRelationships[type] || (mbtiFallbacks ? mbtiFallbacks.relationships : null),
      scores: scores,
      trademark: mbtiTranslations && mbtiTranslations.trademark
        ? mbtiTranslations.trademark
        : 'MBTI®はMyers-Briggs Type Indicator®の商標です。本サービスはMBTI®の公式サービスではありません。'
    };
  }
}
